{% extends 'SupermarketBundle:Admin:index.html.twig' %}

{% block title %}{{ 'admin.search.receipt'|trans }}{% endblock title %}

{% block action %}{{ path('backend_search_receipt') }}{% endblock %}
{% block placeholder %}{{ 'admin.search.receipt'|trans }}{% endblock %}

{% block content %}
    {% if receipts|length > 0 %}
        <h3>{{ 'admin.results'|trans }} "{{ app.request.query.get("query") }}"</h3>
    <table class="table table-hover">
        <thead>
        <tr>
            <th>#</th>
            <th>{{ 'history.date'|trans }}</th>
            <th>{{ 'admin.user.user'|trans }}</th>
            <th>{{ 'history.delivery'|trans }}</th>
            <th>{{ 'history.content'|trans }}</th>
            <th>{{ 'history.total'|trans }}</th>
            <th>{{ 'history.eta'|trans }}</th>
            <th>{{ 'admin.receipts.validation'|trans }}</th>
        </tr>
        </thead>
        <tbody>
        {% for receipt in receipts %}
            <tr>
                <td>{{ receipt.id }}</td>
                <td>{{ receipt.date|date("d/m/Y H:i") }}</td>
                <td>
                    {% if receipt.user_id %}
                        <a href="{{ path('backend_user_receipts', {'id': receipt.user_id.id }) }}">
                            {{ receipt.user_id.lastName }} {{ receipt.user_id.firstName }}
                        </a>
                    {% endif %}
                </td>
                <td>
                    <address>{{ receipt.delivery }}</address>
                </td>
                <td>
                    <button type="button" class="btn btn-default" data-toggle="modal"
                            data-target="#modal_{{ receipt.id }}">{{ 'history.view'|trans }}</button>
                </td>
                <td>{{ receipt.total }} â‚¬</td>
                <td id="eta_{{ receipt.id }}">
                    {% if receipt.validate == 0 %}
                        {{ 'history.pending'|trans }} <span class="glyphicon glyphicon-refresh"></span>
                    {% else %}
                        {{ 'history.valid'|trans }} <span
                            class="glyphicon glyphicon-ok" style="color: green"></span>
                    {% endif %}
                </td>
                <td id="validation_{{ receipt.id }}" style="text-align: center">
                    {% if receipt.validate == 0 %}
                    <a class="btn btn-success valid_receipt" href="{{ path('backend_valid') }}"
                       data-id="{{ receipt.id }}">{{ 'admin.valid'|trans }}</a></td>
                {% else %} - {% endif %}
                <td style="text-align: right!important;">
                    <a href="{{ path('backend_receipt_form', {'id': receipt.id}) }}">
                        <span class="glyphicon glyphicon-pencil"></span>
                    </a>
                    <a href="#" data-toggle="modal" data-target="#modal_{{ receipt.id }}"><span class="glyphicon glyphicon-eye-open"></span></a>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    {% for receipt in receipts %}
        <div id="modal_{{ receipt.id }}" class="modal fade" role="dialog">
            <div class="modal-dialog modal-lg">

                <!-- Modal content-->
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title">{{ 'history.modal.header'|trans }} #{{ receipt.id }}</h4>
                    </div>
                    <div class="modal-body">
                        <table class="table table-responsive table-hover">
                            <thead>
                            <tr>
                                <th>#</th>
                                <th>{{ 'history.picture'|trans }}</th>
                                <th>{{ 'history.modal.name'|trans }}</th>
                                <th>{{ 'history.modal.quantity'|trans }}</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for article in receipt.content %}
                                <tr class="history">
                                    <td>{{ article.id }}</td>
                                    <td><img src="{{ article.media.images.0.thumbnailHdUrl }}"/></td>
                                    <td><a href="{{ path('single', {'id': article.id }) }}">{{ article.name }}</a></td>
                                    <td>{{ article.season }}</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default"
                                data-dismiss="modal">{{ 'history.modal.close'|trans }}</button>
                    </div>
                </div>

            </div>
        </div>
    {% endfor %}
{% else %}
    <h3>{{ 'admin.results'|trans }} "{{app.request.query.get("query")}}"</h3>
    <p>{{ 'admin.empty'|trans }}</p>
{% endif %}
<script>
    $('.valid_receipt').on('click', function (e) {
        e.preventDefault();
        var id = $(this).data('id');
        $.ajax({
            url: "{{ path('backend_valid') }}",
            type: 'get',
            data: 'id=' + id,
            success: function (html) {
                $('#validation_' + id).html(' - ');
                var txt = "{{ 'history.valid'|trans }}";
                $('#eta_' + id).html(txt + "<span class='glyphicon glyphicon-ok' style='color: green'></span>");
                $('#receipts_valid').text(parseInt($('#receipts_valid').html()) + 1);
                $('#receipts_pending').text(parseInt($('#receipts_pending').html()) - 1);
            }
        })
    });
</script>
{% endblock content %}

